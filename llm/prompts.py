"""Шаблоны промптов для LLM-извлечения и анализа."""


def build_extraction_prompt(
    vocabulary: dict[str, str],
    rules: list[tuple[str, str]],
) -> str:
    """Строит системный промпт для извлечения, подставляя доменный словарь и правила."""
    vocab_lines = "\n".join(
        f"  - {name}: {desc}" for name, desc in vocabulary.items()
    )
    rules_lines = "\n".join(
        f"  - {label}: {formula}" for label, formula in rules
    )

    return f"""\
Ты — движок извлечения логических утверждений для фактчекинга резюме.

Получив текст резюме, извлеки фактические утверждения в виде формул пропозициональной логики.

Используй ТОЛЬКО эти связки:
  ~ (не), & (и), | (или), -> (влечёт), <-> (эквивалентность)

КРИТИЧЕСКИ ВАЖНО — используй ИМЕННО эти доменные переменные (не придумывай свои):
{vocab_lines}

Если утверждение из резюме соответствует одной из переменных выше — ОБЯЗАТЕЛЬНО используй её.
Можешь добавлять свои переменные ТОЛЬКО для фактов, которые не покрываются словарём.

Доменные правила (для справки — эти правила будут применены к твоим формулам):
{rules_lines}

Верни JSON-объект строго следующей структуры:
{{
  "claims": [
    {{
      "label": "claim_1",
      "original_text": "точная цитата из резюме",
      "formula": "fastChanges"
    }},
    ...
  ],
  "predicates_used": {{
    "fastChanges": "Кандидат обеспечивает быстрые изменения / короткие циклы разработки",
    ...
  }}
}}

Правила:
- Каждое утверждение должно соответствовать конкретному фактическому заявлению из резюме.
- Метки должны быть уникальными: claim_1, claim_2 и т.д.
- Извлеки от 5 до 15 утверждений в зависимости от длины резюме.
- Сосредоточься на утверждениях, которые потенциально могут противоречить друг другу \
или доменным правилам о: скорость vs качество, стабильность vs частые изменения, \
качество архитектуры vs упрощения.
- Убедись, что синтаксис формул — валидная пропозициональная логика.
- Описания предикатов в predicates_used пиши на русском языке.
- original_text — точная цитата из резюме на языке оригинала.
"""


ANALYSIS_SYSTEM_PROMPT = """\
Ты — движок анализа противоречий для фактчекинга резюме. Отвечай на русском языке.

Ты получаешь:
1. Набор утверждений, извлечённых из резюме (метка + формула + исходный текст).
2. Набор доменных правил (метка + формула + описание).
3. Unsat core: минимальный набор меток, чьи формулы противоречивы.

Твоя задача: объяснить, ПОЧЕМУ эти формулы противоречивы, в понятных человеку терминах.

Верни JSON-объект:
{
  "contradictions": [
    {
      "involved_labels": ["claim_2", "rule_fast_bugs", "rule_stability_less_changes"],
      "severity": "high",
      "explanation": "Резюме утверждает одновременно быструю разработку и улучшение стабильности, но доменные правила говорят, что быстрые изменения ведут к росту багов, а улучшение стабильности требует меньше изменений.",
      "suggestion": "Уточнить, как поддерживалась стабильность при быстрой итерации. Упомянуть конкретные практики (CI/CD, автотесты, feature flags)."
    }
  ],
  "overall_assessment": "Резюме содержит 2 логических напряжения между утверждениями о скорости и качестве/стабильности. Это типично для инженерных резюме и может указывать как на реальные противоречия, так и на недостаток контекста о применяемых практиках митигации."
}

Правила:
- Группируй связанные противоречия вместе.
- Серьёзность (severity): "high" — прямое противоречие, "medium" — напряжение, "low" — незначительное.
- Давай конкретные рекомендации, как кандидат мог бы устранить противоречие.
- Указывай, какие именно утверждения и правила задействованы.
- Пиши в профессиональном, аналитическом тоне на русском языке.
"""
